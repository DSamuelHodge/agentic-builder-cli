/* Minimal dev server with hot-reload friendliness.
 * Swap the HTTP bits with Restackâ€™s official dev server if provided.
 */

import http from "node:http";
import { agents, workflows, functions } from "./routes";
import { defaultLLMProvider } from "./types";

const PORT = Number(process.env.PORT ?? 5233);

const server = http.createServer(async (req, res) => {
  if (!req.url) return;
  if (req.method === "GET" && req.url === "/healthz") {
    res.writeHead(200, { "Content-Type": "application/json" });
    return res.end(JSON.stringify({ ok: true }));
  }

  if (req.method === "POST" && req.url.startsWith("/agents/")) {
    const name = decodeURIComponent(req.url.split("/").pop() || "");
    const body = await readJson(req);
    const factory = (agents as any)[name];
    if (!factory) return send404(res);

    const agent = factory(defaultLLMProvider(), {});
    const messages = body?.messages ?? [];
    const ctx = makeCtx();
    const out = await agent.run(messages, ctx);
    return sendJSON(res, out);
  }

  if (req.method === "POST" && req.url.startsWith("/workflows/")) {
    const name = decodeURIComponent(req.url.split("/").pop() || "");
    const body = await readJson(req);
    const wf = (workflows as any)[name];
    if (!wf) return send404(res);

    const ctx = makeWorkflowCtx();
    const out = await wf(body ?? {}, ctx);
    return sendJSON(res, out);
  }

  if (req.method === "POST" && req.url.startsWith("/functions/")) {
    const name = decodeURIComponent(req.url.split("/").pop() || "");
    const body = await readJson(req);
    const fn = (functions as any)[name];
    if (!fn) return send404(res);

    const ctx = makeCtx();
    const out = await fn(body ?? {}, ctx);
    return sendJSON(res, out);
  }

  send404(res);
});

server.listen(PORT, () =>
  console.log(`[dev] server listening on http://localhost:${PORT}`)
);

function send404(res: http.ServerResponse) {
  res.writeHead(404, { "Content-Type": "application/json" });
  res.end(JSON.stringify({ error: "Not found" }));
}

function sendJSON(res: http.ServerResponse, data: unknown) {
  res.writeHead(200, { "Content-Type": "application/json" });
  res.end(JSON.stringify(data));
}

async function readJson(req: http.IncomingMessage) {
  const chunks: Buffer[] = [];
  for await (const c of req) chunks.push(c as Buffer);
  const raw = Buffer.concat(chunks).toString("utf8");
  return raw ? JSON.parse(raw) : {};
}

function makeCtx() {
  return {
    log: console,
    config: {},
  };
}

function makeWorkflowCtx() {
  return {
    ...makeCtx(),
    llm: defaultLLMProvider(),
    queue: { enqueue: async () => void 0 },
    events: { emit: async () => void 0 },
  };
}
